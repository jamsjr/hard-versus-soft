\documentclass[times, 10pt,twocolumn]{article} 
\usepackage{latex8}
\usepackage{times}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{url}
\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{color}
\usepackage{subfig}

\newtheorem{theorem}{Theorem}[section]

\newcommand{\comentario}[1]{}
\newcommand{\superscript}[1]{\ensuremath{^{\textrm{#1}}}}
\newcounter{notecounter}
\newcommand{\nota}[1]{\addtocounter{notecounter}{1}{\textcolor{red}{[nota
      \arabic{notecounter}: #1]}}}

\newcommand{\gnota}[1]{
  \addtocounter{notecounter}{1}
  \vspace{.5cm}
  \framebox{
    \begin{minipage}{0.95\linewidth}
      \textbf{nota \arabic{notecounter}:} #1
    \end{minipage}
  }\vspace{.5cm}}

\newcommand{\simul}{\textbf{RTSimul}} % Que criatividade. Mudar esse
% nome depois, urgente

\author{Alexandre Passos, George Lima, José Augusto Matos Santos}
%\address{Universidade Federal da Bahia}
\title{Some issues with hard reservation for soft real-time systems}

\begin{document}

\graphicspath{{figs/}{data/}}

\maketitle

\begin{abstract}

  When scheduling soft real-time tasks it is usually a good idea to
  reserve fractions of the total bandwidth to each task (or task
  group). This reservation might be either \textbf{hard}, when under
  no circumstances a task might use some extra bandwidth, or
  \textbf{soft}, if there are some situations when it is allowed to do
  so. Usually, specially in the context of on-line adaptative systems,
  hard reservation is perceived to be more predictable, stricter and
  allowing faster adaptation. In this paper we argue that, perhaps
  surprisingly, allowing tasks to use some idle bandwidth shouldn't
  hurt their performance and reliability. To clarify our arguments we
  present the results of a few experiments performed on real-life and
  syntetic data sets using hard and soft variations of CBS, a commonly
  used reservation-based server.
  
\end{abstract}

\Section{Introduction}
\label{sec:introduction}

In reservation-based scheduling of soft real-time tasks, each task is
allowed at most a given fraction of the total processor time. There
are two broad approaches to using said fraction: \textbf{hard} and
\textbf{soft} reservation. In a hard reservation framework each server
is allowed a given fraction of the total processing time, and in no
ocasion can use more than that fraction. If in some circumstances, a
pending task that has overrun its budget is allowed to use idle
processing time, then the reservation is said to be soft\nota{colocar
  referência da definição}. It is commonly acknowledged that a system
based on hard reservation is more predictable, if not more efficient,
than a system based on soft reservation. In this paper we present a
simulation environment for becnhmarking both reservation mechanisms
and experimental results in this environment that fail to show any
significant benefit either in predictability or in performance.

\SubSection{Related work}
\label{sec:related-work}

In a paper on QoS management thourgh adaptive reservations
\cite{abeni.ea05:qos}, Abeni et al use a hard reservation approach to
help adaptivity. The need for such a restriction on the reservation
will be studied \nota{colocar um experimento com hard e soft
  corretamente dimensionados e variância maior/menor pra ver o que
  acontece} later in this paper.

\SubSection{Contributions of this paper}
\label{sec:contr-this-paper}

The main contribution of this paper is putting into perspective the
perceived characteristics of hard reservation. There is a lack in
literature of experiments in a fair environment that measure
objectively the possible benefits and costs of using hard and soft
reservation in a given system.

\Section{Analytical characteristics}
\label{sec:analyt-char}

In \cite{buttazzo05:soft}, hard reservation is introduced as a way of
proving schedulability of a given task set using a CBS server with a
hard reservation rule. It is done o by means of the following theorems:

\begin{theorem}
  Given a CBS server with the hard reservation rule, and with
  parameters $(Q,P)$, if $k =
  \left\lceil\frac{t-(P-Q)}{P}\right\rceil$, the partition with the
  maximum delay that it can generate has the following least supply
  function $S^*(t)$:
  \[ S^*(t) = \left\{ \begin{array}{ll}
      0 & \text{if}\ t \in [0,P-Q] \\
      (k-1)Q & \text{if}\ t \in (kP - Q, (k+1)P-2Q) \\
      t-(k+1)(P-Q) & \text{otherwise.}
    \end{array}\right.
  \]
\end{theorem}

\begin{theorem}
  Let $A$ be set of periodic or sporadic tasks
  $\{\tau_1,\ldots,\tau_n\}$, with $\tau_i = (C_i,T_i,D_i)$, where
  $C_i$ is the worst-case computation time, $T_i$ is the task period
  and $D_i$ is the relative deadline. This task set is schedulable by
  EDF scheduling algorithm on a resource partition with least supply
  function $S^*(t)$ if and only if:
  \[
  \forall 0 < t \leq 2H : dbf(t) \leq S^*(t)
  \]
  where $H = lcm(T_1,\ldots,T_n)$ is the hyperperiod of A and $dbf(t)$
  is the processor demand bound function, defined as
  \[
  dbf(t) = \sum_{i=1}^n
  \left(\left\lfloor\frac{t-D_i}{T_i}\right\rfloor + 1\right)C_i.
  \]
\end{theorem}

For a proof of these results, see \cite{buttazzo05:soft}.

Interestingly, these theorems can be extended to a soft reservation
framework. Intuitively, if a given task set is schedulable on a hard
cbs server, it means that if the server budget ever runs out when
executing a task from that task set, the task still has time to finish
before its deadline. Since the total computation time available for a
given server deadline is the same under both soft and hard reservation
and no tasks from the original task set are discarded, any task set
schedulable with the hard reservation rule is schedulable with the
soft reservation rule. \nota{formalizar essa prova}

\Section{Simulation environment}
\label{sec:simul-envir}

To perform the experiments presented in this paper we implemented
\simul{}, a simple python-based simulator for real-time scheduling
algorithms. Its source code, the data files used in this paper and
instructions to reproduce our results are available in
\url{http://github.com/jamsjr/hard-versus-soft/tree/master}. \simul{}
implements a basic EDF scheduler and, on top of it, runs both hard
real-time periodic tasks and bandwidth sharing servers. These servers
can be either traditional CBS servers \cite{abeni.ea98:integrating} or
a hard reservation adaptation of the CBS algorithm, as described in
\cite{buttazzo05:soft}. Soft real-time tasks running on these servers
either have their execution times sampled from a probability
distribution or follow traces generated from a modified version of
mplayer that reports the start time and decoding cost for each frame
in a high-resolution video. The time units from this video trace and
our synthetic task sets are entirely arbitrary.

All the simulations performed in this paper share a common
environment. There is a hard real-time task running in the background,
with fixed period, execution costs and deadline. There is also one
soft real-time server (with hard or soft reservation) running tasks
from either the video trace or with costs drawn from a normal
distribution. All tasks considered are periodic, or approximately
periodic. The costs for the background task are calculated to bring
the mean utilization of the system close to 1. Some other aspects of
the simulation, though, are variable, and it is our objective to
understand how they influence the behavior of soft or hard
reservation.

\SubSection{Reservation mechanism}
\label{sec:reserv-mech}

The experiments described in this paper are using the CBS server
\cite{abeni.ea98:integrating}. The original CBS server is described by
a tuple $(Q,T)$ where $Q$ is the server capacity and $T$ is the server
bandwidth. A CBS server runs as a hard real-time task on an EDF
scheduler, executing for roughly $Q$ units of time every period of
length $T$ units of time. In the soft reservation version of the CBS
server, whenever the server capacity runs out it is recharged to its
full value and the current server deadline is delayed by $T$ units of
time. In the hard reservation version, the server always waits until
the next server deadline to recharge its capacity.

\SubSection{Configuation}
\label{sec:controled-variables}

In our simulations we studied the possible effects of the given
configuration variables:
\begin{itemize}
\item discard/not discard any expired tasks;
\item high/low execution cost variance;
\item overloaded/not overloaded system;
\item overloaded/not overloaded server.
\end{itemize}

Not all these variables highlight any difference in whether hard or
soft reservation is better, and by how much. To study the actual
effects of a reservation model, we chose some performance metrics to study.

\SubSection{Performance Metrics}
\label{sec:metrics}

\begin{enumerate}
\item \textbf{Response time}: in a soft real-time system the most
  important concern is maintaining a good \textbf{response time}
  without wasting system resources or prejudicating any hard real-time
  tasks present in the system \cite{buttazzo05:soft}. This suggests
  that a good way to measure performance in soft real-time systems is
  measuring the mean response time of tasks in it.
\item \textbf{Response interval}: on the other hand, measuring just
  the response time of completed tasks is rather naïve, since there
  are many undesirable trade-offs one might make that reduce the mean
  response time for tasks and yet make a system worse performing. A
  simple example is that whenever tasks missing their deadlines are
  discarded one can always reduce mean response time by discarding all
  tasks with a sufficiently high cost. This clearly degrades the
  overall system performance. For this reason we're interested also in
  the mean \textbf{response interval}, which is the interval between
  two successive completions of a task. If no deadlines are missed the
  mean response interval should be near the period of the tasks, but
  whenever tasks are discarded it should go up. We propose that the
  mean response interval is a more robust estimator for the perceived
  performance of a system than the mean response time.
\item \textbf{Delay time}: one supposed difference between soft and
  hard reservation in CBS servers is that, when using soft
  reservation, the server might pospone its deadline indefinitely in a
  period of high load, making for a very low responsivity
  afterwards. To gauge whether or not this is really a problem we are
  also measuring the mean \textbf{delay} between a task's arrival time
  and the time it starts executing. Also, to highlight any perceived
  problems of soft reservation under this condition we use the costs
  seen in figure \ref{fig:plot-trace-trifasico}.
\item \textbf{Deadline miss ratio}: when discarding unfinished tasks,
  a high \textbf{deadline miss ratio} means the system is getting less
  and less useful. One changing scheduling policies, it is always good
  to be sure this value is not getting out of control.
\end{enumerate}

\begin{figure}[t]
  \centering
  \includegraphics[scale=0.5]{metricas}
  \caption{Performance metrics}
  \label{fig:metrics}
\end{figure}

\begin{figure*}[t]
  \centering
  \subfloat[Execution costs for the trace of 'eve'.]{
    \includegraphics[scale=0.33]{trace-eve}
    \label{fig:plot-trace-eve}
  } \subfloat[Normally distributed execution costs over time. Mean 0.6
  time units, standard deviation 0.01]{
    \includegraphics[scale=0.33]{trace-normal}
    \label{fig:plot-trace-normal}
  } \\
  \subfloat[Execution costs designed to simulate adaptivity. The
  standard deviation is always 0.01. The mean starts at 0.4 time
  units, goes up to 0.6 and back to 0.4.]{
    \includegraphics[scale=0.33]{trace-trifasico}
    \label{fig:plot-trace-trifasico}
  }
  \subfloat[Execution costs with low and then high variance. The mean
  is 0.5 time units and the standard deviation starts as 0.01 and goes
  up to 0.1.]{
    \includegraphics[scale=0.33]{trace-variance}
    \label{fig:plot-trace-variance}
  }
  \caption{Execution cost models used in our simulations.}
  \label{fig:ex-costs}
\end{figure*}


\Section{Simulation results}
\label{sec:simulation-results}

We found that not discarding expired tasks makes soft and hard
reservation completely equivalent. In the absence of system idle time,
also, both reservation schemes are equivalent. This suggests that in
systems that are expected to be overloaded or in systems where all
tasks must be run until completion there is no need to worry about
using either soft or hard reservation. Also, if the server load is
low, there is no difference, as there is no need for the soft
reservation mechanism to use any extra bandwidth. Summarizing, the
relevant scenarios are when
\begin{itemize}
\item tasks that have overrun their deadlines are discarded,
\item there is idle time in the system,
\item but the soft real-time server is overloaded.
\end{itemize}
This leaves room for wiggling the variance of execution costs and
specific characteristics of the the task set over time.

To verify the interesting cases, we performed some experiments with
synthetic normally-distributed execution costs. All data sets used in
this paper are shown in figure \ref{fig:ex-costs}.

\SubSection{Synthetic task set}
\label{sec:synthetic-task}

\begin{figure*}[t]
  \centering
  \subfloat[Soft reservation.]{
    \includegraphics[scale=0.33]{trifasico-1}
    \label{fig:soft-trifasico}
  }
  \subfloat[Hard reservation.]{
    \includegraphics[scale=0.33]{trifasico-2}
    \label{fig:hard-trifasico}
  }
  \caption{Response times for the costs in figure
    \ref{fig:plot-trace-trifasico}.}
  \label{fig:trifasico}
\end{figure*}

For the experiment with adaptivity, the results are in figure
\ref{fig:trifasico}. As can be seen, when the server is not under
heavy load both soft and hard reservation perform acceptably. On the
other hand, in the heavily loaded part only the soft reservation
server can use finish tasks that need more than its budget. As
expected, when the load comes back down there is no extra cost for the
soft reservation server, and its response times are equivalent to the
hard reservation ones.

\begin{figure*}[t]
  \centering
  \subfloat[Soft reservation.]{
    \includegraphics[scale=0.33]{variance-1}
    \label{fig:soft-variance}
  }
  \subfloat[Hard reservation.]{
    \includegraphics[scale=0.33]{variance-2}
    \label{fig:hard-variance}
  }
  \caption{Response times for the high variance case.}
  \label{fig:variance}
\end{figure*}


In the high variance experiment, the hard reservation server lost
59.39\% of the deadlines, while the soft reservation only lost
5.19\%. Figure \ref{fig:variance} shows the response times for this
experiment.

\begin{figure*}[t]
  \centering
  \subfloat[Soft reservation.]{
    \includegraphics[scale=0.33]{eve-1}
    \label{fig:soft-eve}
  }
  \subfloat[Hard reservation.]{
    \includegraphics[scale=0.33]{eve-2}
    \label{fig:hard-eve}
  }
  \caption{Delay times for the movie trace.}
  \label{fig:eve}
\end{figure*}


\SubSection{Task set from the movie trace}
\label{sec:task-set-from}

In the delay time experiment, we ran both a soft reservation server
and a hard reservation server on the task set shown in figure
\ref{fig:plot-trace-eve}. Both servers had their periods set to the
mean period of the data set and their capacities were the mean
costs. In the background a hard real-time task runs consuming the
remaining processor bandwidth. As can be easily seen in figure
\ref{fig:eve}, the delay time for the hard reservation server is
always higher than for the soft reservation server. Also, the soft
reservation server only lost 0.1\% of the dealines, while the hard
reservation server lost 24.54\%. This result seems, at first,
counter-intuitive, since the soft reservation server, by delaying its
deadline whenever the execution costs are too high, can have an
arbitrarily low priority. On the other hand, the same task will take
more overall time to be served with a hard reservation server, since
it will have to wait for capacity replenishment before continuing
execution.


\Section{Conclusion}
\label{sec:conclusion}

As can be seen in figures \nota{colocar as figuras}, soft reservation
usually outperforms hard reservation, having a smaller average
response time as well as a smaller worst-case response time, a shorter
delay between task arrival and start of execution, and a more uniform
interval between successive task terminations. Aside from the obvious
capacity of using extra free-time in a soft reservation framework,
some counter-intuitive properties, such as dealing better with
out-of-phase tasks, have been observed.


\bibliographystyle{latex8}
\bibliography{bib}
\end{document}
